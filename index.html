<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TrackMan Tableau WDC - v12-PingTest</title>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
  <script>
    // Fallback for WDC library load error
    if (typeof tableau === 'undefined') {
      console.error('WDC: Tableau WDC library not loaded initially.');
      document.addEventListener('DOMContentLoaded', function() {
        const errDiv = document.getElementById('error-message');
        if (errDiv) {
            errDiv.style.display = 'block';
            errDiv.innerHTML = "<strong>Error:</strong> Tableau WDC library failed to load. Ensure you're running this in Tableau Desktop and have an internet connection.";
        }
      });
    }

    // ======= CONFIGURATION =======
    const config = {
        clientId: 'SheldonMcClelland-baseline',
        clientSecret: '889de571-86db-4c56-a640-e88cd4565526',
        oauthUrl: 'https://login.trackmanbaseball.com/connect/token',
        apiBase: 'https://dataapi.trackmanbaseball.com/api/v1', // Using dataapi as per PDF
        proxyUrl: 'https://tmapi.netlify.app/.netlify/functions/trackman-proxy?url=',
        useTestData: false, // This version will not fetch table data anyway
        schemaIdPitchData: 'TrackManPitchData_v12_PingTest' // Schema ID, though no data will be fetched for it
    };

    // ======= OAUTH TOKEN HANDLING =======
    function getOAuthToken() {
        console.log("WDC: Attempting to fetch new OAuth token.");
        const proxiedTokenUrl = config.proxyUrl + encodeURIComponent(config.oauthUrl);
        const bodyParams = new URLSearchParams();
        bodyParams.append('grant_type', 'client_credentials');
        bodyParams.append('client_id', config.clientId);
        bodyParams.append('client_secret', config.clientSecret);

        console.log("WDC: Requesting token from proxied URL:", proxiedTokenUrl.split("?url=")[0] + "?url=" + decodeURIComponent(proxiedTokenUrl.split("?url=")[1]));

        return fetch(proxiedTokenUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: bodyParams.toString()
        })
        .then(response => {
            console.log("WDC: getOAuthToken - Raw response status from proxy:", response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error("WDC: getOAuthToken - Error response text from proxy:", text.substring(0, 500));
                    let errorMessage = `Token request via proxy failed: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = JSON.parse(text);
                        if(errorData.error && errorData.error.details) {
                             errorMessage += ` - Proxy Error: ${errorData.error.details}`;
                        } else if (errorData.body) {
                            try {
                                const actualError = JSON.parse(errorData.body);
                                errorMessage += ` - Target Error: ${actualError.error_description || actualError.error || String(errorData.body).substring(0,100)}`;
                            } catch (e_parse_body) {
                                errorMessage += ` - Target Response (unparsable): ${String(errorData.body).substring(0,100)}`;
                            }
                        } else if (errorData.error) {
                            errorMessage += ` - Error: ${errorData.error}`;
                        }
                    } catch (e_parse) {
                        errorMessage += ` - Raw Text: ${text.substring(0, 100)}`;
                    }
                    throw new Error(errorMessage);
                });
            }
            return response.json();
        })
        .then(proxyResponseData => {
            console.log("WDC: getOAuthToken - Full response object from proxy (first 500 chars):", JSON.stringify(proxyResponseData).substring(0,500));
            let tokenData;
            if (proxyResponseData && typeof proxyResponseData.body === 'string') {
                try {
                    tokenData = JSON.parse(proxyResponseData.body);
                } catch (e) {
                    console.error("WDC: Failed to parse token data from proxy's response body string:", proxyResponseData.body.substring(0,500));
                    throw new Error("Failed to parse token data from proxy response (body was string).");
                }
            } else if (proxyResponseData && typeof proxyResponseData.body === 'object' && proxyResponseData.body !== null) {
                tokenData = proxyResponseData.body;
            } else if (proxyResponseData && proxyResponseData.access_token) {
                tokenData = proxyResponseData;
            } else {
                console.error("WDC: Token data not found in expected proxy response structure. Proxy response:", JSON.stringify(proxyResponseData).substring(0,500));
                throw new Error("Token data not found in expected proxy response structure.");
            }

            if (tokenData.error) {
                console.error("WDC: OAuth Error (from token endpoint):", tokenData.error, tokenData.error_description);
                throw new Error(tokenData.error_description || tokenData.error || "Unknown OAuth error from token endpoint.");
            }
            if (!tokenData.access_token) {
                console.error("WDC: access_token not found in processed OAuth response:", tokenData);
                throw new Error("Access token not found in processed OAuth response.");
            }
            console.log("WDC: New OAuth access_token fetched successfully.");
            if (tokenData.expires_in) {
                const expiryDate = new Date(Date.now() + tokenData.expires_in * 1000);
                console.log(`WDC: Token expires_in: ${tokenData.expires_in}s. Approx expiry: ${expiryDate} (Client Time)`);
            }
            tableau.password = tokenData.access_token; // Store token for Tableau
            return tokenData.access_token;
        })
        .catch(error => {
            console.error("WDC: Critical Error in getOAuthToken:", error.toString());
            return Promise.reject(error); // Propagate the error
        });
    }

    // ======= TABLEAU WDC LOGIC =======
    const myConnector = tableau.makeConnector();

    myConnector.init = function(initCallback) {
        console.log("WDC: myConnector.init called. Tableau phase:", tableau.phase);
        initCallback();
    };

    myConnector.getSchema = function(schemaCallback) {
        console.log("WDC: myConnector.getSchema called (PingTest version).");
        // Define a minimal schema, as no actual data will be fetched for the table.
        // This is just to satisfy Tableau's requirement for a schema.
        const pitchCols = [
            { id: 'status', dataType: tableau.dataTypeEnum.string, alias: "Test Status" }
        ];
        const tableInfoPitch = {
            id: config.schemaIdPitchData,
            alias: `TrackMan Ping Test ${config.schemaIdPitchData.split('_')[1]}`,
            columns: pitchCols
        };
        schemaCallback([tableInfoPitch]);
    };

    // MODIFIED getData for PING TEST
    myConnector.getData = function(table, doneCallback) {
        console.log("WDC: Basic Network Test - getData called for table:", table.tableInfo.id);
        tableau.reportProgress("Basic Network Test: Attempting to fetch OAuth token...");

        getOAuthToken()
            .then(freshToken => {
                if (freshToken) {
                    console.log("WDC: Basic Network Test - Token fetched successfully via proxy.");
                    tableau.log("Basic Network Test: Token fetch SUCCESSFUL.");
                    // Optionally, append a dummy row to indicate success to Tableau UI if table is shown
                    if (table.tableInfo.id === config.schemaIdPitchData) {
                        // table.appendRows([{ "status": "Token Ping Successful" }]);
                        // For now, let's not append any rows to keep it simple and just see if it completes.
                    }
                } else {
                    // This path should ideally not be taken if getOAuthToken properly rejects on error.
                    console.error("WDC: Basic Network Test - Token was not returned by getOAuthToken, but no error was caught by getData's .catch(). This is unexpected.");
                    tableau.abortWithError("Basic Network Test: Token was empty (unexpected state).");
                }
                doneCallback(); // End immediately after token attempt
            })
            .catch(error => {
                console.error("WDC: Basic Network Test - Failed to get token:", error.toString());
                tableau.abortWithError("Basic Network Test FAILED: Authentication error - " + error.toString() + ". Check Netlify logs for token endpoint call.");
            });
    };
    // The full fetchAllDataHistorically function is intentionally omitted in this PingTest version.

    // Register the connector
    if (typeof tableau !== 'undefined' && tableau.makeConnector) {
        tableau.registerConnector(myConnector);
        console.log("WDC: Connector registered with Tableau.");
    } else {
        console.error('WDC: Cannot register connector: tableau object or tableau.makeConnector not available.');
        document.addEventListener('DOMContentLoaded', function() {
            const errDiv = document.getElementById('error-message');
            if (errDiv) errDiv.style.display = 'block';
            const button = document.getElementById('connectButton');
            if (button) button.disabled = true;
        });
    }
  </script>
</head>
<body>
  <h1>TrackMan Tableau WDC - v12-PingTest</h1>
  <div id="error-message" style="display:none; color:red; margin:10px 0; padding:10px; border: 1px solid red;">
    </div>
  <p><strong>Mode:</strong> This is a Ping Test version. It only attempts to fetch an OAuth token.</p>
  <button id="connectButton" onclick="if(typeof tableau !== 'undefined' && tableau.connectionName !== undefined) { tableau.connectionName='TrackMan API v12-PingTest'; tableau.submit(); } else { alert('This button must be run within Tableau Desktop\'s Web Data Connector interface after the WDC library has loaded.'); }">
    Run Ping Test (Get Token)
  </button>
</body>
</html>
